{% doc %}
  @prompt
     create a product carousel with scrollable product cards. below that the arrow keys. then a arrow key will be press there should be a main product in the center and on left and right side two products should be show , i want more compact product card size. in mobile version two product on left and right side should be visible half so that it looks beautiful., there shouldn't be no last dot. it should be like circle after last product there should be first product and it's scrollable. remove the dots icon, after the last product card when i click next be there is a flick not smooth like others. it should be smooth like others , still have the flick between last and first product card 
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-product-carousel-{{ ai_gen_id }} {
    padding: 30px 0;
    background-color: {{ block.settings.background_color }};
    overflow: hidden;
  }

  .ai-product-carousel__container-{{ ai_gen_id }} {
    max-width: 1400px;
    margin: 0 auto;
  }

  .ai-product-carousel__heading-{{ ai_gen_id }} {
    text-align: center;
    margin: 0 0 30px;
    font-size: {{ block.settings.heading_size }}px;
    color: {{ block.settings.text_color }};
    padding: 0 20px;
  }

  .ai-product-carousel__viewport-{{ ai_gen_id }} {
    position: relative;
    overflow: hidden;
    margin-bottom: 24px;
    padding: 0 20px;
  }

  .ai-product-carousel__track-{{ ai_gen_id }} {
    display: flex;
    gap: {{ block.settings.card_gap }}px;
    padding: 16px 0;
  }

  .ai-product-carousel__card-{{ ai_gen_id }} {
    flex: 0 0 calc((100% - {{ block.settings.card_gap | times: 4 }}px) / 5);
    background-color: {{ block.settings.card_background }};
    border-radius: {{ block.settings.card_border_radius }}px;
    overflow: hidden;
    transition: all 0.3s ease;
    opacity: 0.5;
    transform: scale(0.85);
  }

  .ai-product-carousel__card-{{ ai_gen_id }}.active {
    opacity: 1;
    transform: scale(1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .ai-product-carousel__card-{{ ai_gen_id }}.side {
    opacity: 0.8;
    transform: scale(0.92);
  }

  .ai-product-carousel__image-wrapper-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    overflow: hidden;
    background-color: #f4f4f4;
  }

  .ai-product-carousel__image-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .ai-product-carousel__image-placeholder-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ai-product-carousel__image-placeholder-{{ ai_gen_id }} svg {
    width: 60%;
    height: 60%;
    opacity: 0.3;
  }

  .ai-product-carousel__info-{{ ai_gen_id }} {
    padding: 12px;
  }

  .ai-product-carousel__title-{{ ai_gen_id }} {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 6px;
    color: {{ block.settings.text_color }};
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.3;
  }

  .ai-product-carousel__price-{{ ai_gen_id }} {
    font-size: 16px;
    font-weight: 700;
    color: {{ block.settings.price_color }};
    margin-bottom: 10px;
  }

  .ai-product-carousel__button-{{ ai_gen_id }} {
    width: 100%;
    padding: 8px 12px;
    background-color: {{ block.settings.button_color }};
    color: {{ block.settings.button_text_color }};
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: background-color 0.3s ease;
  }

  .ai-product-carousel__button-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.button_hover_color }};
  }

  .ai-product-carousel__controls-{{ ai_gen_id }} {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 0 20px;
  }

  .ai-product-carousel__arrow-{{ ai_gen_id }} {
    width: {{ block.settings.arrow_size }}px;
    height: {{ block.settings.arrow_size }}px;
    background-color: {{ block.settings.arrow_background }};
    color: {{ block.settings.arrow_color }};
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .ai-product-carousel__arrow-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.arrow_hover_background }};
    transform: scale(1.1);
  }

  .ai-product-carousel__arrow-{{ ai_gen_id }} svg {
    width: 20px;
    height: 20px;
  }

  .ai-product-carousel__empty-{{ ai_gen_id }} {
    text-align: center;
    padding: 60px 20px;
    color: #999;
    font-size: 16px;
  }

  @media screen and (max-width: 1200px) {
    .ai-product-carousel__card-{{ ai_gen_id }} {
      flex: 0 0 calc((100% - {{ block.settings.card_gap | times: 2 }}px) / 3);
    }
  }

  @media screen and (max-width: 768px) {
    .ai-product-carousel__viewport-{{ ai_gen_id }} {
      padding: 0 10px;
    }

    .ai-product-carousel__track-{{ ai_gen_id }} {
      gap: 12px;
      padding: 12px 0;
    }

    .ai-product-carousel__card-{{ ai_gen_id }} {
      flex: 0 0 calc(70% - 12px);
    }

    .ai-product-carousel__heading-{{ ai_gen_id }} {
      font-size: {{ block.settings.heading_size | times: 0.7 }}px;
      margin-bottom: 20px;
    }

    .ai-product-carousel__info-{{ ai_gen_id }} {
      padding: 10px;
    }

    .ai-product-carousel__title-{{ ai_gen_id }} {
      font-size: 13px;
      margin-bottom: 5px;
    }

    .ai-product-carousel__price-{{ ai_gen_id }} {
      font-size: 15px;
      margin-bottom: 8px;
    }

    .ai-product-carousel__button-{{ ai_gen_id }} {
      padding: 7px 10px;
      font-size: 12px;
    }

    .ai-product-carousel__controls-{{ ai_gen_id }} {
      gap: 16px;
    }

    .ai-product-carousel__arrow-{{ ai_gen_id }} {
      width: {{ block.settings.arrow_size | times: 0.8 }}px;
      height: {{ block.settings.arrow_size | times: 0.8 }}px;
    }

    .ai-product-carousel__arrow-{{ ai_gen_id }} svg {
      width: 16px;
      height: 16px;
    }
  }
{% endstyle %}

<product-carousel-{{ ai_gen_id }}
  class="ai-product-carousel-{{ ai_gen_id }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-product-carousel__container-{{ ai_gen_id }}">
    {% if block.settings.heading != blank %}
      <h2 class="ai-product-carousel__heading-{{ ai_gen_id }}">{{ block.settings.heading }}</h2>
    {% endif %}

    {% if block.settings.collection != blank and block.settings.collection.products.size > 0 %}
      <div class="ai-product-carousel__viewport-{{ ai_gen_id }}">
        <div class="ai-product-carousel__track-{{ ai_gen_id }}" data-track>
          {% for product in block.settings.collection.products limit: block.settings.products_limit %}
            <div class="ai-product-carousel__card-{{ ai_gen_id }}" data-card data-index="{{ forloop.index0 }}">
              <div class="ai-product-carousel__image-wrapper-{{ ai_gen_id }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 600 }}"
                    alt="{{ product.featured_image.alt | escape }}"
                    class="ai-product-carousel__image-{{ ai_gen_id }}"
                    loading="lazy"
                    width="600"
                    height="600"
                  >
                {% else %}
                  <div class="ai-product-carousel__image-placeholder-{{ ai_gen_id }}">
                    {{ 'product-1' | placeholder_svg_tag }}
                  </div>
                {% endif %}
              </div>
              <div class="ai-product-carousel__info-{{ ai_gen_id }}">
                <h3 class="ai-product-carousel__title-{{ ai_gen_id }}">{{ product.title }}</h3>
                <div class="ai-product-carousel__price-{{ ai_gen_id }}">
                  {{ product.price | money }}
                </div>
                <a
                  href="{{ product.url }}"
                  class="ai-product-carousel__button-{{ ai_gen_id }}"
                >
                  {{ block.settings.button_text }}
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="ai-product-carousel__controls-{{ ai_gen_id }}">
        <button
          class="ai-product-carousel__arrow-{{ ai_gen_id }} ai-product-carousel__arrow--prev-{{ ai_gen_id }}"
          data-prev
          aria-label="Previous product"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>

        <button
          class="ai-product-carousel__arrow-{{ ai_gen_id }} ai-product-carousel__arrow--next-{{ ai_gen_id }}"
          data-next
          aria-label="Next product"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
    {% else %}
      <div class="ai-product-carousel__empty-{{ ai_gen_id }}">
        Next, select a collection to display products
      </div>
    {% endif %}
  </div>
</product-carousel-{{ ai_gen_id }}>

<script>
  (function() {
    class ProductCarousel{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.currentIndex = 0;
        this.totalProducts = 0;
        this.isTransitioning = false;
      }

      connectedCallback() {
        this.track = this.querySelector('[data-track]');
        this.cards = Array.from(this.querySelectorAll('[data-card]'));
        this.prevButton = this.querySelector('[data-prev]');
        this.nextButton = this.querySelector('[data-next]');

        if (!this.track || this.cards.length === 0) return;

        this.totalProducts = this.cards.length;
        this.cloneCards();
        this.setupEventListeners();
        
        requestAnimationFrame(() => {
          this.updateCarousel(false);
        });
      }

      cloneCards() {
        const clonesToCreate = Math.min(this.totalProducts, 5);
        const clonesBefore = [];
        const clonesAfter = [];

        for (let i = 0; i < clonesToCreate; i++) {
          const originalIndexBefore = (this.totalProducts - 1 - i + this.totalProducts) % this.totalProducts;
          const originalIndexAfter = i % this.totalProducts;
          
          const cloneBefore = this.cards[originalIndexBefore].cloneNode(true);
          const cloneAfter = this.cards[originalIndexAfter].cloneNode(true);
          
          cloneBefore.classList.add('clone');
          cloneAfter.classList.add('clone');
          cloneBefore.removeAttribute('data-index');
          cloneAfter.removeAttribute('data-index');
          
          clonesBefore.unshift(cloneBefore);
          clonesAfter.push(cloneAfter);
        }

        clonesBefore.forEach(clone => this.track.insertBefore(clone, this.track.firstChild));
        clonesAfter.forEach(clone => this.track.appendChild(clone));

        this.allCards = Array.from(this.track.children);
        this.cloneCount = clonesToCreate;
        this.currentIndex = this.cloneCount;
      }

      setupEventListeners() {
        this.prevButton.addEventListener('click', () => this.prev());
        this.nextButton.addEventListener('click', () => this.next());

        this.track.addEventListener('transitionend', (e) => {
          if (e.target !== this.track) return;
          if (!this.isTransitioning) return;
          
          this.handleLooping();
        });

        let startX = 0;
        let isDragging = false;

        this.track.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
          isDragging = true;
        });

        this.track.addEventListener('touchend', (e) => {
          if (!isDragging) return;
          const endX = e.changedTouches[0].clientX;
          const diff = startX - endX;

          if (Math.abs(diff) > 50) {
            if (diff > 0) {
              this.next();
            } else {
              this.prev();
            }
          }
          isDragging = false;
        });

        window.addEventListener('resize', () => {
          requestAnimationFrame(() => this.updateCarousel(false));
        });
      }

      handleLooping() {
        this.isTransitioning = false;
        
        if (this.currentIndex >= this.totalProducts + this.cloneCount) {
          this.currentIndex = this.cloneCount;
          this.updateCarousel(false);
        } else if (this.currentIndex < this.cloneCount) {
          this.currentIndex = this.totalProducts + this.cloneCount - 1;
          this.updateCarousel(false);
        }
      }

      prev() {
        if (this.isTransitioning) return;
        this.isTransitioning = true;
        this.currentIndex--;
        this.updateCarousel(true);
      }

      next() {
        if (this.isTransitioning) return;
        this.isTransitioning = true;
        this.currentIndex++;
        this.updateCarousel(true);
      }

      updateCarousel(animate) {
        const cardWidth = this.allCards[0].offsetWidth;
        const isMobile = window.innerWidth <= 768;
        const isTablet = window.innerWidth <= 1200 && window.innerWidth > 768;

        let gap;
        let offset;

        if (isMobile) {
          gap = 12;
          const viewportWidth = this.track.parentElement.offsetWidth;
          const cardVisibleWidth = cardWidth;
          const centerOffset = (viewportWidth - cardVisibleWidth) / 2;
          offset = (this.currentIndex * (cardWidth + gap)) - centerOffset;
        } else if (isTablet) {
          gap = {{ block.settings.card_gap }};
          offset = (this.currentIndex - 1) * (cardWidth + gap);
        } else {
          gap = {{ block.settings.card_gap }};
          offset = (this.currentIndex - 2) * (cardWidth + gap);
        }

        this.track.style.transition = animate ? 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)' : 'none';
        this.track.style.transform = `translateX(-${offset}px)`;

        this.allCards.forEach((card, index) => {
          card.classList.remove('active', 'side');

          if (index === this.currentIndex) {
            card.classList.add('active');
          } else if (
            index === this.currentIndex - 1 ||
            index === this.currentIndex + 1 ||
            index === this.currentIndex - 2 ||
            index === this.currentIndex + 2
          ) {
            card.classList.add('side');
          }
        });
      }
    }

    customElements.define('product-carousel-{{ ai_gen_id }}', ProductCarousel{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Product carousel",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Featured products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "min": 3,
      "max": 20,
      "step": 1,
      "label": "Maximum products",
      "default": 10
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "View product"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 20,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Heading size",
      "default": 36
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Card style"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Card border radius",
      "default": 12
    },
    {
      "type": "range",
      "id": "card_gap",
      "min": 10,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Gap between cards",
      "default": 20
    },
    {
      "type": "header",
      "content": "Button style"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_hover_color",
      "label": "Button hover color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Button border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Arrow controls"
    },
    {
      "type": "range",
      "id": "arrow_size",
      "min": 40,
      "max": 80,
      "step": 4,
      "unit": "px",
      "label": "Arrow size",
      "default": 56
    },
    {
      "type": "color",
      "id": "arrow_background",
      "label": "Arrow background",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow icon color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "arrow_hover_background",
      "label": "Arrow hover background",
      "default": "#333333"
    }
  ],
  "presets": [
    {
      "name": "Product carousel"
    }
  ]
}
{% endschema %}