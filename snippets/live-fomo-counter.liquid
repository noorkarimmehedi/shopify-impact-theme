{% comment %}
  Home & Kitchen Live Counter - Shopify Snippet (Mobile Optimized)
  
  Usage: {% render 'home-kitchen-live-counter' %}
  
  Customization:
  {% render 'home-kitchen-live-counter',
    initial_viewers: 127,
    initial_stock: 39,
    min_viewers: 85,
    max_viewers: 180,
    min_stock: 0
  %}
  
  NOTE: Each product will automatically get different stock numbers!
  The snippet uses product ID to randomize initial stock between 35-45 units.
{% endcomment %}

{% assign unique_id = section.id | default: 'default' | append: '-' | append: block.id | default: 'snippet' %}

{% comment %} Generate random stock based on product ID {% endcomment %}
{% if initial_stock == blank or initial_stock == null %}
  {% assign product_id_num = product.id | default: 0 %}
  {% assign seed = product_id_num | modulo: 11 %}
  {% assign initial_stock = seed | plus: 35 %}
{% endif %}

{% comment %} Default Settings {% endcomment %}
{% assign initial_viewers = initial_viewers | default: 127 %}
{% assign initial_stock = initial_stock | default: 39 %}
{% assign min_viewers = min_viewers | default: 85 %}
{% assign max_viewers = max_viewers | default: 180 %}
{% assign min_stock = min_stock | default: 0 %}

{% style %}
  .kitchen-counter-{{ unique_id }} {
    background: linear-gradient(135deg, #FFFFFF 0%, #FFF5F5 100%);
    border: 1.5px solid #FF1744;
    border-radius: 6px;
    padding: 8px;
    margin: 8px 0;
    box-shadow: 0 0 20px rgba(213, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
    contain: layout style paint;
    transform: translateZ(0);
  }

  .kitchen-counter__live-badge-{{ unique_id }} {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #D50000;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    border: 1px solid #E0E0E0;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 5px;
  }

  .kitchen-counter__live-dot-{{ unique_id }} {
    width: 5px;
    height: 5px;
    background: white;
    border-radius: 50%;
  }

  /* Disable pulse animation on mobile to save battery */
  @media (min-width: 768px) {
    .kitchen-counter__live-dot-{{ unique_id }} {
      animation: live-pulse-{{ unique_id }} 3s ease-in-out infinite;
    }
  }

  @keyframes live-pulse-{{ unique_id }} {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .kitchen-counter__viewers-{{ unique_id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-bottom: 5px;
    padding: 5px 8px;
    background: white;
    border-radius: 5px;
    border: 1px solid #FFE0E0;
  }

  .kitchen-counter__viewer-icons-{{ unique_id }} {
    display: flex;
    gap: 2px;
  }

  .kitchen-counter__eye-icon-{{ unique_id }} {
    width: 16px;
    height: 16px;
  }

  .kitchen-counter__eye-icon-{{ unique_id }} svg {
    width: 100%;
    height: 100%;
    fill: #D50000;
  }

  .kitchen-counter__viewers-text-{{ unique_id }} {
    color: #1F2937;
    font-size: 12px;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
  }

  .kitchen-counter__viewers-number-{{ unique_id }} {
    font-weight: 800;
    color: #D50000;
    font-size: 14px;
    display: inline-block;
    min-width: 26px;
    text-align: center;
    contain: layout;
  }

  .kitchen-counter__stock-section-{{ unique_id }} {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background: white;
    padding: 6px 8px;
    border-radius: 5px;
    border: 1.5px solid #FFE0E0;
  }

  .kitchen-counter__stock-header-{{ unique_id }} {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .kitchen-counter__stock-label-{{ unique_id }} {
    font-size: 11px;
    font-weight: 700;
    color: #D50000;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .kitchen-counter__stock-icon-{{ unique_id }} {
    width: 14px;
    height: 14px;
  }

  .kitchen-counter__stock-count-{{ unique_id }} {
    background: linear-gradient(135deg, #D50000 0%, #FF1744 100%);
    color: white;
    padding: 3px 8px;
    border-radius: 6px;
    border: 1px solid #E0E0E0;
    font-size: 11px;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .kitchen-counter__stock-number-{{ unique_id }} {
    font-size: 14px;
    min-width: 20px;
    text-align: center;
    contain: layout;
  }

  .kitchen-counter__progress-bar-{{ unique_id }} {
    height: 6px;
    background: linear-gradient(90deg, #FFE0E0 0%, #FFF5F5 100%);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    border: 1px solid #FFD0D0;
    contain: layout;
  }

  .kitchen-counter__progress-fill-{{ unique_id }} {
    height: 100%;
    background: linear-gradient(90deg, #D50000 0%, #FF1744 100%);
    border-radius: 4px;
    transition: transform 0.5s ease-out;
    transform-origin: left;
  }

  /* Disable animations on mobile */
  @media (max-width: 767px) {
    .kitchen-counter__progress-fill-{{ unique_id }} {
      transition: none;
    }
    
    .kitchen-counter__updating-{{ unique_id }} {
      animation: none !important;
    }
  }

  /* Only enable pop animation on desktop */
  @media (min-width: 768px) {
    .kitchen-counter__updating-{{ unique_id }} {
      animation: update-pop-{{ unique_id }} 0.3s ease;
    }
  }

  @keyframes update-pop-{{ unique_id }} {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* Responsive Design */
  @media screen and (min-width: 640px) {
    .kitchen-counter-{{ unique_id }} {
      padding: 10px 12px;
    }

    .kitchen-counter__viewers-text-{{ unique_id }} {
      font-size: 13px;
    }

    .kitchen-counter__viewers-number-{{ unique_id }} {
      font-size: 15px;
    }

    .kitchen-counter__stock-label-{{ unique_id }} {
      font-size: 12px;
    }

    .kitchen-counter__progress-bar-{{ unique_id }} {
      height: 7px;
    }
  }

  /* Force GPU acceleration off on mobile */
  @media (max-width: 767px) {
    .kitchen-counter-{{ unique_id }},
    .kitchen-counter__progress-fill-{{ unique_id }} {
      transform: none;
      will-change: auto;
    }
  }
{% endstyle %}

<div class="kitchen-counter-{{ unique_id }}" id="kitchen-counter-{{ unique_id }}">
  <!-- Live Badge -->
  <div class="kitchen-counter__live-badge-{{ unique_id }}">
    <div class="kitchen-counter__live-dot-{{ unique_id }}"></div>
    <span>Live Now</span>
  </div>

  <!-- Viewers Section -->
  <div class="kitchen-counter__viewers-{{ unique_id }}">
    <div class="kitchen-counter__viewer-icons-{{ unique_id }}">
      <div class="kitchen-counter__eye-icon-{{ unique_id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
      </div>
    </div>
    <p class="kitchen-counter__viewers-text-{{ unique_id }}">
      <span class="kitchen-counter__viewers-number-{{ unique_id }}" data-viewers="{{ initial_viewers }}">{{ initial_viewers }}</span> people viewing now
    </p>
  </div>

  <!-- Stock Section -->
  <div class="kitchen-counter__stock-section-{{ unique_id }}">
    <div class="kitchen-counter__stock-header-{{ unique_id }}">
      <p class="kitchen-counter__stock-label-{{ unique_id }}">
        <svg class="kitchen-counter__stock-icon-{{ unique_id }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#D50000">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        In Stock
      </p>
      <div class="kitchen-counter__stock-count-{{ unique_id }}">
        <span class="kitchen-counter__stock-number-{{ unique_id }}" data-stock="{{ initial_stock }}">{{ initial_stock }}</span>
        <span>units</span>
      </div>
    </div>
    
    <div class="kitchen-counter__progress-container-{{ unique_id }}">
      <div class="kitchen-counter__progress-bar-{{ unique_id }}">
        <div class="kitchen-counter__progress-fill-{{ unique_id }}" data-progress style="transform: scaleX(1);"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const uniqueId = '{{ unique_id }}';
    const container = document.getElementById('kitchen-counter-' + uniqueId);
    
    if (!container) return;

    const viewersElement = container.querySelector('[data-viewers]');
    const stockElement = container.querySelector('[data-stock]');
    const progressBar = container.querySelector('[data-progress]');

    let currentViewers = {{ initial_viewers }};
    let currentStock = {{ initial_stock }};
    const initialStock = {{ initial_stock }};

    // Detect if mobile device
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
    
    const config = {
      minViewers: {{ min_viewers }},
      maxViewers: {{ max_viewers }},
      minStock: {{ min_stock }},
      // Much slower updates on mobile to prevent heating
      viewerUpdateInterval: isMobile ? 20000 : 10000,  // 20s on mobile, 10s on desktop
      stockUpdateInterval: isMobile ? 15000 : 8000     // 15s on mobile, 8s on desktop
    };

    let viewerInterval = null;
    let stockInterval = null;
    let isTabActive = true;
    let isVisible = false;
    let rafId = null;

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateProgressBar() {
      const percentage = currentStock / initialStock;
      // Use transform instead of width for better performance
      if (progressBar) {
        progressBar.style.transform = `scaleX(${percentage})`;
      }
    }

    function updateViewers() {
      if (!isTabActive || !isVisible) return;
      
      const change = randomBetween(-3, 5);
      let newViewers = currentViewers + change;

      newViewers = Math.max(config.minViewers, Math.min(config.maxViewers, newViewers));

      if (newViewers !== currentViewers) {
        currentViewers = newViewers;
        
        // Skip animation on mobile
        if (!isMobile) {
          viewersElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
          setTimeout(() => {
            viewersElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
          }, 300);
        }
        
        viewersElement.textContent = currentViewers;
      }
    }

    function updateStock() {
      if (!isTabActive || !isVisible) return;
      
      if (currentStock > config.minStock) {
        currentStock = Math.max(config.minStock, currentStock - 1);
        
        // Skip animation on mobile
        if (!isMobile) {
          stockElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
          setTimeout(() => {
            stockElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
          }, 300);
        }
        
        stockElement.textContent = currentStock;
        updateProgressBar();
      }
    }

    function startIntervals() {
      stopIntervals();
      
      if (!isMobile || isVisible) {
        viewerInterval = setInterval(updateViewers, config.viewerUpdateInterval);
        stockInterval = setInterval(updateStock, config.stockUpdateInterval);
      }
    }

    function stopIntervals() {
      if (viewerInterval) {
        clearInterval(viewerInterval);
        viewerInterval = null;
      }
      if (stockInterval) {
        clearInterval(stockInterval);
        stockInterval = null;
      }
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
    }

    // Intersection Observer - only run when visible
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            isVisible = entry.isIntersecting;
            
            if (isVisible && isTabActive) {
              startIntervals();
            } else {
              stopIntervals();
            }
          });
        },
        { threshold: 0.1 }
      );
      
      observer.observe(container);
    } else {
      // Fallback for older browsers
      isVisible = true;
      startIntervals();
    }

    // Initialize
    updateProgressBar();
    
    // Skip initial drop animation on mobile
    if (!isMobile) {
      // Drop from 39 to 35 in first 6 seconds (4 units)
      const initialDropInterval = 1500;
      let dropCount = 0;
      const maxInitialDrops = 4;
      
      const initialDropTimer = setInterval(() => {
        if (dropCount < maxInitialDrops && currentStock > config.minStock) {
          currentStock--;
          dropCount++;
          
          stockElement.textContent = currentStock;
          updateProgressBar();
          
          if (dropCount >= maxInitialDrops) {
            clearInterval(initialDropTimer);
            if (isVisible) {
              startIntervals();
            }
          }
        }
      }, initialDropInterval);
    } else {
      // On mobile, just update once without animation
      currentStock = Math.max(35, currentStock - 4);
      stockElement.textContent = currentStock;
      updateProgressBar();
      if (isVisible) {
        startIntervals();
      }
    }

    // Pause when tab is not visible
    document.addEventListener('visibilitychange', () => {
      isTabActive = !document.hidden;
      
      if (isTabActive && isVisible) {
        startIntervals();
      } else {
        stopIntervals();
      }
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      stopIntervals();
    });
  })();
</script>