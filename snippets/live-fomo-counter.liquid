{% comment %}
  Home & Kitchen Live Counter - Shopify Snippet
  
  Usage: {% render 'home-kitchen-live-counter' %}
  
  Customization:
  {% render 'home-kitchen-live-counter',
    initial_viewers: 127,
    initial_stock: 24,
    min_viewers: 85,
    max_viewers: 180,
    min_stock: 3
  %}
{% endcomment %}

{% assign unique_id = section.id | default: 'default' | append: '-' | append: block.id | default: 'snippet' %}

{% comment %} Default Settings {% endcomment %}
{% assign initial_viewers = initial_viewers | default: 127 %}
{% assign initial_stock = initial_stock | default: 24 %}
{% assign min_viewers = min_viewers | default: 85 %}
{% assign max_viewers = max_viewers | default: 180 %}
{% assign min_stock = min_stock | default: 3 %}

{% style %}
  .kitchen-counter-{{ unique_id }} {
    background: linear-gradient(135deg, #FFFFFF 0%, #FFF5F5 100%);
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    padding: 12px;
    margin: 12px 0;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .kitchen-counter-{{ unique_id }}::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #D50000 0%, #FF1744 50%, #D50000 100%);
    background-size: 200% 100%;
    animation: gradient-shift-{{ unique_id }} 3s ease infinite;
  }

  @keyframes gradient-shift-{{ unique_id }} {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  .kitchen-counter-{{ unique_id }}:hover {
    border-color: #CCCCCC;
  }

  .kitchen-counter__live-badge-{{ unique_id }} {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #D50000;
    color: white;
    padding: 3px 8px;
    border-radius: 8px;
    border: 1px solid #E0E0E0;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0);
    transition: border-color 0.3s ease;
  }

  .kitchen-counter__live-badge-{{ unique_id }}:hover {
    border-color: #CCCCCC;
  }

  .kitchen-counter__live-dot-{{ unique_id }} {
    width: 5px;
    height: 5px;
    background: white;
    border-radius: 50%;
    position: relative;
    animation: live-pulse-{{ unique_id }} 1.5s ease-in-out infinite;
  }

  @keyframes live-pulse-{{ unique_id }} {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
  }

  .kitchen-counter__viewers-{{ unique_id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-bottom: 8px;
    padding: 8px 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid #FFE0E0;
    position: relative;
  }

  .kitchen-counter__viewer-icons-{{ unique_id }} {
    display: flex;
    gap: 2px;
  }

  .kitchen-counter__eye-icon-{{ unique_id }} {
    width: 16px;
    height: 16px;
    position: relative;
    animation: eye-blink-{{ unique_id }} 4s ease-in-out infinite;
  }

  .kitchen-counter__eye-icon-{{ unique_id }}:nth-child(2) {
    animation-delay: 0.5s;
  }

  .kitchen-counter__eye-icon-{{ unique_id }}:nth-child(3) {
    animation-delay: 1s;
  }

  @keyframes eye-blink-{{ unique_id }} {
    0%, 48%, 52%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(0.8); opacity: 0.7; }
  }

  .kitchen-counter__eye-icon-{{ unique_id }} svg {
    width: 100%;
    height: 100%;
    fill: #D50000;
    filter: drop-shadow(0 2px 4px rgba(213, 0, 0, 0.2));
  }

  .kitchen-counter__viewers-text-{{ unique_id }} {
    color: #1F2937;
    font-size: 12px;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
  }

  .kitchen-counter__viewers-number-{{ unique_id }} {
    font-weight: 800;
    color: #D50000;
    font-size: 14px;
    display: inline-block;
    min-width: 26px;
    text-align: center;
    animation: number-glow-{{ unique_id }} 2s ease-in-out infinite;
  }

  @keyframes number-glow-{{ unique_id }} {
    0%, 100% { text-shadow: 0 0 8px rgba(213, 0, 0, 0.3); }
    50% { text-shadow: 0 0 16px rgba(213, 0, 0, 0.5); }
  }

  .kitchen-counter__stock-section-{{ unique_id }} {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: white;
    padding: 10px;
    border-radius: 6px;
    border: 2px solid #FFE0E0;
  }

  .kitchen-counter__stock-header-{{ unique_id }} {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .kitchen-counter__stock-label-{{ unique_id }} {
    font-size: 11px;
    font-weight: 700;
    color: #D50000;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .kitchen-counter__stock-icon-{{ unique_id }} {
    width: 14px;
    height: 14px;
    animation: rotate-{{ unique_id }} 3s linear infinite;
  }

  @keyframes rotate-{{ unique_id }} {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .kitchen-counter__stock-count-{{ unique_id }} {
    background: linear-gradient(135deg, #D50000 0%, #FF1744 100%);
    color: white;
    padding: 5px 12px;
    border-radius: 8px;
    border: 1px solid #E0E0E0;
    font-size: 11px;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0);
    transition: border-color 0.3s ease;
  }

  .kitchen-counter__stock-count-{{ unique_id }}:hover {
    border-color: #CCCCCC;
  }

  .kitchen-counter__stock-number-{{ unique_id }} {
    font-size: 14px;
    min-width: 20px;
    text-align: center;
  }

  .kitchen-counter__progress-container-{{ unique_id }} {
    position: relative;
  }

  .kitchen-counter__progress-bar-{{ unique_id }} {
    height: 8px;
    background: linear-gradient(90deg, #FFE0E0 0%, #FFF5F5 100%);
    border-radius: 5px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
    border: 1px solid #FFD0D0;
  }

  .kitchen-counter__progress-fill-{{ unique_id }} {
    height: 100%;
    background: linear-gradient(90deg, #D50000 0%, #FF1744 100%);
    border-radius: 5px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 8px rgba(213, 0, 0, 0.4);
  }

  .kitchen-counter__progress-fill-{{ unique_id }}::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.6) 50%, transparent 100%);
    animation: shimmer-{{ unique_id }} 2s infinite;
  }

  .kitchen-counter__progress-fill-{{ unique_id }}::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%);
  }

  @keyframes shimmer-{{ unique_id }} {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .kitchen-counter__updating-{{ unique_id }} {
    animation: update-pop-{{ unique_id }} 0.5s ease;
  }

  @keyframes update-pop-{{ unique_id }} {
    0%, 100% { transform: scale(1); }
    30% { transform: scale(1.15); }
    60% { transform: scale(0.95); }
  }

  .kitchen-counter__urgency-text-{{ unique_id }} {
    text-align: center;
    font-size: 10px;
    color: #DC2626;
    font-weight: 600;
    margin-top: 6px;
    animation: fade-pulse-{{ unique_id }} 2s ease-in-out infinite;
  }

  @keyframes fade-pulse-{{ unique_id }} {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
  }

  /* Responsive Design */
  @media screen and (min-width: 640px) {
    .kitchen-counter-{{ unique_id }} {
      padding: 14px 16px;
    }

    .kitchen-counter__viewers-text-{{ unique_id }} {
      font-size: 13px;
    }

    .kitchen-counter__viewers-number-{{ unique_id }} {
      font-size: 15px;
    }

    .kitchen-counter__stock-label-{{ unique_id }} {
      font-size: 12px;
    }

    .kitchen-counter__progress-bar-{{ unique_id }} {
      height: 9px;
    }
  }
{% endstyle %}

<div class="kitchen-counter-{{ unique_id }}" id="kitchen-counter-{{ unique_id }}">
  <!-- Live Badge -->
  <div class="kitchen-counter__live-badge-{{ unique_id }}">
    <div class="kitchen-counter__live-dot-{{ unique_id }}"></div>
    <span>Live Now</span>
  </div>

  <!-- Viewers Section -->
  <div class="kitchen-counter__viewers-{{ unique_id }}">
    <div class="kitchen-counter__viewer-icons-{{ unique_id }}">
      <div class="kitchen-counter__eye-icon-{{ unique_id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
      </div>
      <div class="kitchen-counter__eye-icon-{{ unique_id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
      </div>
      <div class="kitchen-counter__eye-icon-{{ unique_id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
      </div>
    </div>
    <p class="kitchen-counter__viewers-text-{{ unique_id }}">
      <span class="kitchen-counter__viewers-number-{{ unique_id }}" data-viewers="{{ initial_viewers }}">{{ initial_viewers }}</span> people viewing now
    </p>
  </div>

  <!-- Stock Section -->
  <div class="kitchen-counter__stock-section-{{ unique_id }}">
    <div class="kitchen-counter__stock-header-{{ unique_id }}">
      <p class="kitchen-counter__stock-label-{{ unique_id }}">
        <svg class="kitchen-counter__stock-icon-{{ unique_id }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#D50000">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        In Stock
      </p>
      <div class="kitchen-counter__stock-count-{{ unique_id }}">
        <span class="kitchen-counter__stock-number-{{ unique_id }}" data-stock="{{ initial_stock }}">{{ initial_stock }}</span>
        <span>units</span>
      </div>
    </div>
    
    <div class="kitchen-counter__progress-container-{{ unique_id }}">
      <div class="kitchen-counter__progress-bar-{{ unique_id }}">
        <div class="kitchen-counter__progress-fill-{{ unique_id }}" data-progress style="width: 100%;"></div>
      </div>
    </div>

    <p class="kitchen-counter__urgency-text-{{ unique_id }}">
      ðŸ“Œ Limited stock â€” get it before it sells out!
    </p>
  </div>
</div>

<script>
  (function() {
    const uniqueId = '{{ unique_id }}';
    const container = document.getElementById('kitchen-counter-' + uniqueId);
    
    if (!container) return;

    const viewersElement = container.querySelector('[data-viewers]');
    const stockElement = container.querySelector('[data-stock]');
    const progressBar = container.querySelector('[data-progress]');

    let currentViewers = {{ initial_viewers }};
    let currentStock = {{ initial_stock }};
    const initialStock = {{ initial_stock }};

    const config = {
      minViewers: {{ min_viewers }},
      maxViewers: {{ max_viewers }},
      minStock: {{ min_stock }},
      viewerUpdateInterval: 3500, // Update viewers every 3.5 seconds for live feel
      stockUpdateInterval: 8000  // Update stock every 8 seconds for back-to-back sales
    };

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateProgressBar() {
      const percentage = (currentStock / initialStock) * 100;
      progressBar.style.width = percentage + '%';
    }

    function updateViewers() {
      // More dynamic viewer changes for live feel
      const change = randomBetween(-4, 7);
      let newViewers = currentViewers + change;

      if (newViewers > config.maxViewers) newViewers = config.maxViewers;
      if (newViewers < config.minViewers) newViewers = config.minViewers;

      if (newViewers !== currentViewers) {
        currentViewers = newViewers;
        viewersElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
        viewersElement.textContent = currentViewers;

        setTimeout(() => {
          viewersElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
        }, 500);
      }
    }

    function updateStock() {
      if (currentStock > config.minStock) {
        // Reduce by exactly 1 unit every minute
        currentStock = Math.max(config.minStock, currentStock - 1);

        stockElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;
        
        updateProgressBar();

        setTimeout(() => {
          stockElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
        }, 500);
      }
    }

    // Initialize
    updateProgressBar();

    // Start intervals
    const viewerInterval = setInterval(updateViewers, config.viewerUpdateInterval);
    const stockInterval = setInterval(updateStock, config.stockUpdateInterval);

    // Add more variation to viewers for realistic feel
    setTimeout(() => {
      updateViewers();
    }, randomBetween(1000, 3000));

    // Cleanup
    window.addEventListener('beforeunload', () => {
      clearInterval(viewerInterval);
      clearInterval(stockInterval);
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearInterval(viewerInterval);
        clearInterval(stockInterval);
      }
    });
  })();
</script>