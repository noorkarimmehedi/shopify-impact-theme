{% comment %}
  Home & Kitchen Live Counter - Shopify Snippet (Redesigned)
  
  Usage: {% render 'home-kitchen-live-counter' %}
  
  Customization:
  {% render 'home-kitchen-live-counter',
    initial_viewers: 127,
    initial_stock: 39,
    min_viewers: 85,
    max_viewers: 180,
    min_stock: 0
  %}
  
  NOTE: Each product will automatically get different stock numbers!
  The snippet uses product ID to randomize initial stock between 35-45 units.
{% endcomment %}

{% assign unique_id = section.id | default: 'default' | append: '-' | append: block.id | default: 'snippet' %}

{% comment %} Generate random stock based on product ID {% endcomment %}
{% if initial_stock == blank or initial_stock == null %}
  {% assign product_id_num = product.id | default: 0 %}
  {% assign seed = product_id_num | modulo: 11 %}
  {% assign initial_stock = seed | plus: 35 %}
{% endif %}

{% comment %} Default Settings {% endcomment %}
{% assign initial_viewers = initial_viewers | default: 127 %}
{% assign initial_stock = initial_stock | default: 39 %}
{% assign min_viewers = min_viewers | default: 85 %}
{% assign max_viewers = max_viewers | default: 180 %}
{% assign min_stock = min_stock | default: 0 %}

{% style %}
  .kitchen-counter-{{ unique_id }} {
    background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
    border: 3px solid #D50000;
    border-radius: 16px;
    padding: 20px 18px;
    margin: 16px 0;
    box-shadow: 0 4px 20px rgba(213, 0, 0, 0.25);
    position: relative;
    overflow: hidden;
    will-change: auto;
  }

  /* Decorative circles like the coupon design */
  .kitchen-counter-{{ unique_id }}::before,
  .kitchen-counter-{{ unique_id }}::after {
    content: '';
    position: absolute;
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
  }

  .kitchen-counter-{{ unique_id }}::before {
    left: -15px;
  }

  .kitchen-counter-{{ unique_id }}::after {
    right: -15px;
  }

  .kitchen-counter__header-{{ unique_id }} {
    text-align: center;
    margin-bottom: 16px;
  }

  .kitchen-counter__title-{{ unique_id }} {
    font-size: 18px;
    font-weight: 900;
    color: #1F2937;
    margin: 0 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .kitchen-counter__live-badge-{{ unique_id }} {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #D50000;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .kitchen-counter__live-dot-{{ unique_id }} {
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    animation: live-pulse-{{ unique_id }} 2s ease-in-out infinite;
  }

  @keyframes live-pulse-{{ unique_id }} {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(0.85); }
  }

  /* Main content box */
  .kitchen-counter__content-{{ unique_id }} {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Viewers Section */
  .kitchen-counter__viewers-{{ unique_id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
    padding: 12px 14px;
    background: linear-gradient(135deg, #FFF9E6 0%, #FFFAF0 100%);
    border-radius: 10px;
    border: 2px dashed #D50000;
  }

  .kitchen-counter__eye-icon-{{ unique_id }} {
    width: 20px;
    height: 20px;
  }

  .kitchen-counter__eye-icon-{{ unique_id }} svg {
    width: 100%;
    height: 100%;
    fill: #D50000;
  }

  .kitchen-counter__viewers-text-{{ unique_id }} {
    color: #1F2937;
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
  }

  .kitchen-counter__viewers-number-{{ unique_id }} {
    font-weight: 900;
    color: #D50000;
    font-size: 18px;
    display: inline-block;
    min-width: 30px;
    text-align: center;
  }

  /* Stock Section */
  .kitchen-counter__stock-section-{{ unique_id }} {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .kitchen-counter__stock-header-{{ unique_id }} {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .kitchen-counter__stock-label-{{ unique_id }} {
    font-size: 13px;
    font-weight: 800;
    color: #1F2937;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .kitchen-counter__stock-icon-{{ unique_id }} {
    width: 16px;
    height: 16px;
  }

  .kitchen-counter__stock-count-{{ unique_id }} {
    background: #D50000;
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 900;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 6px rgba(213, 0, 0, 0.3);
  }

  .kitchen-counter__stock-number-{{ unique_id }} {
    font-size: 16px;
    min-width: 24px;
    text-align: center;
  }

  /* Progress Bar */
  .kitchen-counter__progress-container-{{ unique_id }} {
    position: relative;
  }

  .kitchen-counter__progress-bar-{{ unique_id }} {
    height: 24px;
    background: linear-gradient(90deg, #F0F0F0 0%, #E8E8E8 100%);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    border: 2px solid #D50000;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .kitchen-counter__progress-fill-{{ unique_id }} {
    height: 100%;
    background: linear-gradient(90deg, #D50000 0%, #FF1744 50%, #D50000 100%);
    background-size: 200% 100%;
    border-radius: 10px;
    transition: width 0.5s ease-out;
    animation: progress-shimmer-{{ unique_id }} 2s linear infinite;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 900;
    font-size: 11px;
    letter-spacing: 0.5px;
  }

  @keyframes progress-shimmer-{{ unique_id }} {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .kitchen-counter__progress-text-{{ unique_id }} {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 900;
    color: #D50000;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    z-index: 2;
    white-space: nowrap;
  }

  .kitchen-counter__updating-{{ unique_id }} {
    animation: update-pop-{{ unique_id }} 0.3s ease;
  }

  @keyframes update-pop-{{ unique_id }} {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
  }

  .kitchen-counter__urgency-text-{{ unique_id }} {
    text-align: center;
    font-size: 11px;
    color: #D50000;
    font-weight: 700;
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Responsive Design */
  @media screen and (min-width: 640px) {
    .kitchen-counter-{{ unique_id }} {
      padding: 24px 22px;
    }

    .kitchen-counter__title-{{ unique_id }} {
      font-size: 20px;
    }

    .kitchen-counter__viewers-text-{{ unique_id }} {
      font-size: 15px;
    }

    .kitchen-counter__viewers-number-{{ unique_id }} {
      font-size: 20px;
    }

    .kitchen-counter__stock-label-{{ unique_id }} {
      font-size: 14px;
    }

    .kitchen-counter__progress-bar-{{ unique_id }} {
      height: 26px;
    }

    .kitchen-counter__progress-text-{{ unique_id }} {
      font-size: 12px;
    }
  }

  /* Reduce animations on mobile devices */
  @media (prefers-reduced-motion: reduce) {
    .kitchen-counter__live-dot-{{ unique_id }},
    .kitchen-counter__updating-{{ unique_id }},
    .kitchen-counter__progress-fill-{{ unique_id }} {
      animation: none;
    }
  }
{% endstyle %}

<div class="kitchen-counter-{{ unique_id }}" id="kitchen-counter-{{ unique_id }}">
  <!-- Header Section -->
  <div class="kitchen-counter__header-{{ unique_id }}">
    <h3 class="kitchen-counter__title-{{ unique_id }}">ðŸ”¥ Live Stock Update</h3>
    <div class="kitchen-counter__live-badge-{{ unique_id }}">
      <div class="kitchen-counter__live-dot-{{ unique_id }}"></div>
      <span>Live Now</span>
    </div>
  </div>

  <!-- Main Content Box -->
  <div class="kitchen-counter__content-{{ unique_id }}">
    <!-- Viewers Section -->
    <div class="kitchen-counter__viewers-{{ unique_id }}">
      <div class="kitchen-counter__eye-icon-{{ unique_id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
      </div>
      <p class="kitchen-counter__viewers-text-{{ unique_id }}">
        <span class="kitchen-counter__viewers-number-{{ unique_id }}" data-viewers="{{ initial_viewers }}">{{ initial_viewers }}</span> viewing now
      </p>
    </div>

    <!-- Stock Section -->
    <div class="kitchen-counter__stock-section-{{ unique_id }}">
      <div class="kitchen-counter__stock-header-{{ unique_id }}">
        <p class="kitchen-counter__stock-label-{{ unique_id }}">
          <svg class="kitchen-counter__stock-icon-{{ unique_id }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#D50000">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
          </svg>
          Stock Remaining
        </p>
        <div class="kitchen-counter__stock-count-{{ unique_id }}">
          <span class="kitchen-counter__stock-number-{{ unique_id }}" data-stock="{{ initial_stock }}">{{ initial_stock }}</span>
          <span>units</span>
        </div>
      </div>
      
      <div class="kitchen-counter__progress-container-{{ unique_id }}">
        <div class="kitchen-counter__progress-bar-{{ unique_id }}">
          <div class="kitchen-counter__progress-fill-{{ unique_id }}" data-progress style="width: 100%;"></div>
          <div class="kitchen-counter__progress-text-{{ unique_id }}" data-progress-text>
            <span data-stock-display>{{ initial_stock }}</span> / {{ initial_stock }} LEFT
          </div>
        </div>
      </div>

      <p class="kitchen-counter__urgency-text-{{ unique_id }}">âš¡ Hurry! Stock is running out fast</p>
    </div>
  </div>
</div>

<script>
  (function() {
    const uniqueId = '{{ unique_id }}';
    const container = document.getElementById('kitchen-counter-' + uniqueId);
    
    if (!container) return;

    const viewersElement = container.querySelector('[data-viewers]');
    const stockElement = container.querySelector('[data-stock]');
    const stockDisplayElement = container.querySelector('[data-stock-display]');
    const progressBar = container.querySelector('[data-progress]');

    let currentViewers = {{ initial_viewers }};
    let currentStock = {{ initial_stock }};
    const initialStock = {{ initial_stock }};

    const config = {
      minViewers: {{ min_viewers }},
      maxViewers: {{ max_viewers }},
      minStock: {{ min_stock }},
      viewerUpdateInterval: 8000,
      stockUpdateInterval: 6000
    };

    let viewerInterval = null;
    let stockInterval = null;
    let isTabActive = true;

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateProgressBar() {
      const percentage = (currentStock / initialStock) * 100;
      progressBar.style.width = percentage + '%';
      
      if (stockDisplayElement) {
        stockDisplayElement.textContent = currentStock;
      }
    }

    function updateViewers() {
      if (!isTabActive) return;
      
      const change = randomBetween(-3, 5);
      let newViewers = currentViewers + change;

      newViewers = Math.max(config.minViewers, Math.min(config.maxViewers, newViewers));

      if (newViewers !== currentViewers) {
        currentViewers = newViewers;
        viewersElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
        viewersElement.textContent = currentViewers;

        setTimeout(() => {
          viewersElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
        }, 300);
      }
    }

    function updateStock() {
      if (!isTabActive) return;
      
      if (currentStock > config.minStock) {
        currentStock = Math.max(config.minStock, currentStock - 1);

        stockElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;
        
        updateProgressBar();

        setTimeout(() => {
          stockElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
        }, 300);
      }
    }

    function startIntervals() {
      if (viewerInterval) clearInterval(viewerInterval);
      if (stockInterval) clearInterval(stockInterval);
      
      viewerInterval = setInterval(updateViewers, config.viewerUpdateInterval);
      stockInterval = setInterval(updateStock, config.stockUpdateInterval);
    }

    function stopIntervals() {
      if (viewerInterval) clearInterval(viewerInterval);
      if (stockInterval) clearInterval(stockInterval);
      viewerInterval = null;
      stockInterval = null;
    }

    // Initialize
    updateProgressBar();
    
    // Drop from 39 to 35 in first 6 seconds (4 units)
    const initialDropInterval = 1500;
    let dropCount = 0;
    const maxInitialDrops = 4;
    
    const initialDropTimer = setInterval(() => {
      if (dropCount < maxInitialDrops && currentStock > config.minStock) {
        currentStock--;
        dropCount++;
        
        stockElement.classList.add('kitchen-counter__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;
        updateProgressBar();
        
        setTimeout(() => {
          stockElement.classList.remove('kitchen-counter__updating-{{ unique_id }}');
        }, 300);
        
        if (dropCount >= maxInitialDrops) {
          clearInterval(initialDropTimer);
          startIntervals();
        }
      }
    }, initialDropInterval);

    // Pause when tab is not visible
    document.addEventListener('visibilitychange', () => {
      isTabActive = !document.hidden;
      
      if (isTabActive) {
        startIntervals();
      } else {
        stopIntervals();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopIntervals();
    });
  })();
</script>